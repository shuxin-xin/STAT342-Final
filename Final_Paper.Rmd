---
title: "BNT162b2 Vaccine Efficiency Analysis"
subtitle: "Likelihood, Bayesian, Bootstrapping"
author: "Yanting Hu, Liuyixin Shao, Shuxin Zhang"
graphics: yes
output: 
        pdf_document:
         toc: false
         number_sections: true
urlcolor: blue
header-includes:
- \usepackage{amsmath,amsfonts,amssymb}
- \usepackage{multicol,graphicx,hyperref,xcolor}
- \usepackage{setspace} \doublespacing
fontsize: 11pt

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r load-packages, message=FALSE, echo = F}
library(tidyverse)
library(openintro)
library(maxLik)
library(ggplot2)
library(patchwork)
```

# Abstract

The coronavirus disease 2019 (Covid-19) has afflicted tens of millions of people around the world. A total of 34,922 participants were randomly selected, while 8 out of 17,411 in the BNT162b2 group were infected and 162 out of 17,511 in the Placebo group were infected. This paper is about security and Effectiveness tests for BNT162b2 Vaccine by using three methods: Likelihood, Bayesian, and Bootstrapping. We found that BNT162b2 Vaccine conferred approximately 95% protection against Covid-19 in persons 16 years of age or beyond. The median of the vaccine's safety...

# Keywords

Covid-19; BNT162b2-vaccine; Likelihood; Bayesian; Bootstrapping

# Introduction

  In 2019, human beings experiences an unprecedented outbreak of respiratory infections. This is a worldwide disease known as coronavirus disease 2019 (Covid-19). The first cases of novel coronavirus are detected in China and then spread to other countries across the world. During more than 3 years pandemic, “over 2 million people in the European Region have died from the disease.” \footnote{(Coronavirus Disease (COVID-19) Pandemic)} At the beginning of the outbreak, people didn't expect it to last for a long time and treated it like a common flu. However, because the infected person is exposed to the crowd for a long time, the development of new coronary pneumonia is out of control and gradually forms a global disease.

  How to effectively control the epidemic? Isolation is often the first and most effective measure that comes to mind when attempting to control an epidemic. It is a logical approach since, without person-to-person contact, the virus cannot spread. However, it is essential to understand that this approach requires a sustained effort until the government can confidently ensure the quarantine of all infected individuals. It is undeniable that Quarantine and social distancing are one of the most effective ways to prevent the virus from spreading, however, this method also lead to "elevated levels of loneliness and social isolation, which in turn produce physical- and mental-health related repercussions." \footnote{(Hwang et al.)}
  
  So it becomes meaningful to control the spread of the virus from the human body itself, and vaccination is one of them. The effective vaccines can greatly reduce "diseases that once routinely harmed or killed babies, children, and adults." \footnote{(“Adult Vaccination - Reasons to Vaccinate.”)}
  
  BNT162b2 vaccine, a Covid 19 vaccine developed by Pfizer, has entered public's view. BNT162b2 is a vaccine containing modified RNA, encapsulated in lipid nanoparticles, that carries the genetic instructions for producing a stable form of the SARS-CoV-2 spike protein, which is anchored to the viral membrane. And in this research, individuals aged 16 years or older were randomly divided into two groups. One group received two doses of either a placebo or the BNT162b2 vaccine. The two doses were rigorously administered 21 days apart. And then, researchers measure the effectiveness of vaccine by record the number of occurrence of laboratory-confirmed COVID-19. By analyzing the data calculated, we could use many statistics model to illustrates the effectiveness of the BNT162b2 vaccine.
  
  Many previous studies have already explored the effects of the BNT162b2 vaccine, while this study illustrates and records a real-life experiment. In the following sections, we will analyse whether BNT162b2 vaccine is efficient and safety enough to against laboratory-confirmed Covid 19 by three methods: likelihood, Bayesian, and bootstrapping.


# Statistical Method
## Preprocessing
### Our Data
Based on the paper, we have the table:
\begin{table}[h]
\centering
\caption{Vaccine Efficacy against Covid 19 at least 7 days after second dose in patients without evidence of infection}
\begin{tabular}{cccc}
Group & Cases & No. of subjects\\ \hline
BNT162b2 & 8 & 17,411 \\
Placebo & 162 & 17,511 \\ \hline
Total & 170 & 34,922 \\ \hline
\end{tabular}
\end{table}
### Two Statistical Models and Their Corresponding Parameters and Assumptions
To do appropriate inference, our three models are built on two different approaches: 1) the two binomial proportions approach and 2) the one-sample binomial approach.

1) First, it's natural for us to treat the data into a two binomial proportions problem.

Let $X$ denote the number of infection cases among $n_1 = 17411$ subjects assigned to the BNT162b2 group and $Y$ denote the number of infection cases among $n_2 = 17511$ subjects assigned to the Placebo group.

Let $\pi_v$ and $\pi_p$ denote the probabilities of an infection in the vaccine and placebo groups respectively.

Since participants underwent randomization in the paper, every subject is independent of each other. With independence and infection probability $\pi_v$ and $\pi_p$ for the vaccine and placebo groups, a reasonable model that we can use for $X$ and $Y$ is $X \sim Binom(\pi_v, n_1 = 17411)$ and $Y \sim Binom(\pi_p, n_2 = 17511)$. 

Then, the parameter of interest, which is the vaccine efficacy is:
$\psi = 1 - \frac{\pi_v}{\pi_p} = \frac{\pi_p - \pi_v}{\pi_p}$

Based on the data from the table above, we can easily calculated that $\pi_v = \frac{8}{17411}$, $\pi_p = \frac{162}{17511}$, and $\hat{\psi} = \frac{\pi_p - \pi_v}{\pi_p}=0.9503337$.

That means the vaccine BNT162b2 can reduce risk of having COVID 19 by around 95\% compare to placebo.

We will utilize these approach in the non-parametric bootstrapping approach.

2) Second, we can further reduce the problem to a one sample problem by conditioning on the number of total cases and making more assumptions:

Let $S$ denote the total cases in two groups where $S=X+Y$ and let $T$ denotes the number of cases in vaccine group from $S$ total cases. 

Let $V$ denote the event that "being assigned to BNT162b2 group" and $I$ denote the event that "infections".

Then, $P(V)$, the probability of subjects being assigned to the BNT162b2 group, is $\frac{n_1}{n_1+n_2}$. Then, by the rule of complement, $P(V^c)$, the probability of subjects being assigned to the placebo group, is $\frac{n_2}{n_1+n_2}$.

Then, by distributive laws, $P(I)$, the probability of infections, is:
\begin{align*}
P(I) &= P(I\cap (V\cup V^c))=P((I\cap V)\cup(I\cap V^c))\\
&=P(I \cap V) + P(I \cap V^c) -P((I \cap V)\cap(I \cap V^c))\qquad\mbox{by addition rule}\\
&= P(I \cap V) + P(I^c \cap V^c)\qquad\mbox{since complement sets are disjointed}\\
&=P(I|V) P(V) + P(I|V^c) P(V^c) \qquad\mbox{by definition of conditional probability} \\
&= \pi_v \cdot \frac{n_1}{n_1+n_2} + \pi_p \cdot \frac{n_2}{n_1+n_2} \\
&= \frac{n_1 \pi_v + n_2 \pi_p}{n_1 + n_2}
\end{align*}
Let $\pi$ denote the probability of a subject with the BNT162b2 vaccine but in the infection group, that is $\pi = P(V|I)=P(\text{BNT162b2 | COVID 19})$.

Since participants underwent randomization in the paper, every case is independent of each other. With independence and a fixed probability of $\pi$, a reasonable model that we can use for $T$ is $T \sim Binom(s, \pi)$ where $\pi = P(V|I)$. Now, let's find $\pi$:

By Bayes’ rule, we know that $P(V|I) = \frac{P(I|V)P(V)}{P(I)}$

where $P(I|V)$ represents the probability of infections given that being assigned to BNT162b2 group, which is $\pi_v$ and $P(I|V^c)$ represents the probability of infections given that being assigned to placebo group, which is $\pi_p$.

Then, by definition of conditional probability, we can calculate $\pi = P(V|I)$ as follows:
$\pi = P(V|I) = \frac{P(I|V)P(V)}{P(I)} = \frac{\pi_v \cdot \frac{n_1}{n_1+n_2}}{\frac{n_1 \pi_v + n_2 \pi_p}{n_1 + n_2}} = \frac{n_1\pi_v}{n_1+n_2} \cdot \frac{n_1+n_2}{n_1 \pi_v + n_2 \pi_p} = \frac{n_1\pi_v}{n_1 \pi_v + n_2 \pi_p}$

By the table, we know that $n_1=17411$ and $n_2=17511$. Since $n_1 \approx n2$, we can say that the randomization is 1:1 and further approximate $\pi$ as $\pi = \frac{n_1\pi_v}{n_1\pi_v+n_2\pi_p}= \frac{n_1\pi_v}{n_1\pi_v+n_1\pi_p}= \frac{n_1\pi_v}{n_1(\pi_v+\pi_p)}= \frac{\pi_v}{\pi_v+\pi_p}$.

Then, the parameter of interest, which is the vaccine efficacy represented by $\pi$ is:
$\psi = 1 - \frac{\pi_v}{\pi_p} = 1 - \frac{\pi}{1-\pi} = \frac{1-2\pi}{1-\pi}$.

- (we can put these steps in the appendix)
The parameter of interest is vaccine efficacy $\psi$, that is 

\begin{align*}
\psi &= \frac{\pi_p - \pi_v}{\pi_p} \\
&= 1 - \frac{\pi_v}{\pi_p} \\
\end{align*}

Then, we can find $\frac{\pi_v}{\pi_p}$ by using $\pi$

\begin{align*}
\pi &= \frac{\pi_v}{\pi_v+\pi_p} \\
\pi(\pi_v+\pi_p) &= \pi_v \\
\pi \pi_v + \pi \pi_p &= \pi_v \\
\pi \pi_p &= \pi_v - \pi \pi_v \\
\pi \pi_p &= \pi_v (1 - \pi) \\
\frac{\pi_v}{\pi_p} &= \frac{\pi}{1-\pi}
\end{align*}
- (we can put these steps in the appendix)

Based on the data from the table, we can easily calculated that $s=x+y=8+162=170$ and $\pi=\frac{\pi_v}{\pi_v+\pi_p}=0.04731632$. Then, $T \sim Binom(s=170, \pi=0.04731632)$ where $\pi_v$ and $\pi_p$ are the probabilities of an infection in the vaccine and placebo groups respectively.

We will utilize these approach in the Maximum Likelihood, Bayesian, and parametric bootstrapping approach.

### Hypothesis of Interest

(To do hypothesis test for inference, we first need to make certain assumptions to make our test valid.) 

The FDA requires at least 30% efficacy for a new therapy to be approved. Let $\psi_0$ represent the true value of $\psi$, which is the vaccine efficacy for BNT162b2.

Then, our null hypothesis is: "The vaccine efficacy of BNT162b2 is 30%", which is $H_0: \psi_0=0.3$.

Our alternative hypothesis is: "The vaccine efficacy of BNT162b2 over 30%", which is $H_1: \psi_0>0.3$.


```{r ,include = F}
loglikelihood = function(params) {
  pi_v <- params[1]
  pi_p <- params[2]
  
  binom_v = choose(df[1,4],df[1,2])* pi_v^(df[1,2]) * (1- pi_v)^(df[1,4]-df[1,2])
  binom_p = choose(df[2,4],df[2,2])* pi_p^(df[2,2]) * (1- pi_p)^(df[2,4]-df[2,2])
  result = log(binom_v) + log(binom_p)
  #return(-result)
  ifelse(pi_v < 0 | pi_v > 1 | pi_p < 0 | pi_p > 1, NA,
         result)
}
#maxLik(logLik = loglikelihood, start = c(0.0004,0.009), method = "NR")
#maxLik(logLik = loglikelihood, start = c(0.001,0.0004), method = "NR")
#optim(par = c(0,1), function(m)loglikelihood(m[1],m[2],m[3]), fn = loglikelihood)$par
#optim(par = c(0.001, 0.0009), function(m)loglikelihood(m[1],m[2]), method = "BFGS")$par
```



## Likelihood 

Now, want to find the Likelihood Estimator

\begin{align*}
\pi &= \frac{\pi_v}{\pi_v +\pi_p} \\
\pi_v &= \pi \cdot \pi_v + \pi \cdot \pi_p \\
\pi_p &= \frac{(1 - \pi) \cdot \pi_v}{\pi} \\
\text{Because known that: } \psi &= \frac{\pi_p - \pi_v}{\pi_p} = \frac{\frac{(1 - \pi) \cdot \pi_v}{\pi} - \pi_v}{\frac{(1 - \pi) \cdot \pi_v}{\pi}} \\
&= \frac{1 - 2\pi}{\pi} \cdot \pi_v \cdot \frac{\pi}{(1 - \pi) \cdot \pi_v}\\
\psi &= \frac{1 - 2 \pi}{1 - \pi} \\
\pi &= \frac{1 - \psi}{2 - \psi} \\
\end{align*}

Based on the data given, $s = 170$, so we have $T \sim Binom(170, \pi_0)$

The likelihood function is then 

\begin{align*}
f(t) &= \binom{170}{t} \cdot \pi_0^{t} \cdot (1 - \pi_0)^{170 - t} \\
L(\psi) &= \binom{170}{t} \cdot (\frac{1 - \psi}{2 - \psi})^{t} \cdot (1 - \frac{1 - \psi}{2 - \psi})^{170 - t} \\
&= \binom{170}{t} \cdot (\frac{1 - \psi}{2 - \psi})^{t} \cdot (\frac{1}{2 - \psi})^{170 - t} \\
\ell(\psi) &= log(\binom{170}{t} \cdot (\frac{1 - \psi}{2 - \psi})^{t} \cdot (\frac{1}{2 - \psi})^{170 - t}) \\
&= ln(\binom{170}{t}) + t \cdot (ln(1 - \psi) - ln(2 - \psi)) + (t - 170) \cdot ln(2 - \psi) \\
\end{align*}

Then, in order to calculate the candidates for MLE, we need to know the first derivative condition:

\begin{align*}
\frac{d}{d \psi} \ell(\psi) &= \frac{d}{d \psi} (ln(\binom{170}{t}) + t \cdot (ln(1 - \psi) - ln(2 - \psi)) + (t - 170) \cdot ln(2 - \psi)) \\
&= -\frac{t}{1 - \psi} + \frac{t}{2 - \psi} - \frac{t - 170}{2 - \psi} \\
&= -\frac{t}{1 - \psi} + \frac{170}{2 - \psi} = 0 \\
\frac{t}{1 - \psi} &= \frac{170}{2 - \psi} \\
170 - 170 \cdot \psi &= 2t - t \cdot \psi \\
(170 - t) \cdot \psi &= 170 - 2\cdot t \\
\psi &= \frac{170 - 2\cdot t}{170 - t} \\
\text{Given that 8 cases in Vaccine group: } \psi &= \frac{170 - 2\cdot 8}{170 - 8} = 0.9506173 \\
\end{align*}

Therefore, $\widehat{\psi^{mle}} = 0.9506173$ is a candidate for the MLE of $\psi$. To check whether this candidate is a maximum value, we need to calculate the second derivative test:

\begin{align*}
\frac{d^2}{d \psi^2} \ell(\psi) &= \ell''(\psi) \\
&= \frac{d^2}{d \psi^2} (-\frac{t}{1 - \psi} + \frac{170}{2 - \psi}) \\
&= \frac{-t}{(1 - \psi)^{2}} + \frac{170}{(2 - \psi)^{2}} \\
\text{Given that 8 cases in Vaccine group: } &= \frac{-8}{(1 - \psi)^{2}} + \frac{170}{(2 - \psi)^{2}} \\
&= \frac{-8\cdot (2 - \psi)^{2} + 170 \cdot (1 - \psi)^{2}}{(1 - \psi)^{2} \cdot (2 - \psi)^{2}} \\
\text{Because: } (1 - \psi)^{2} \cdot (2 - \psi)^{2} &> 0 \\
\text{And because } \widehat{\psi^{mle}} &= 0.95061731 \\
-8\cdot (2 - 0.95061731)^{2} + 170 \cdot (1 - 0.95061731)^{2} &=  -8 \cdot 1.101204 + 170 \cdot 0.00243865 \\
&= -8.395062 < 0 \\
\text{we have } \ell''(\psi) &<0 \\
\end{align*}

Therefore, $\widehat{\psi^{mle}} = 0.95061731$ is a MLE for $\psi$. Based on the given information in Chapter 25, we have the estimated variance of the MLE of $\psi$ is $-\frac{1}{\ell''(\widehat{\psi^{mle}})}$

\begin{align*}
Var[\widehat{\psi^{mle}}] &= -\frac{1}{\ell''(\widehat{\psi^{mle}})} \\
&= -\frac{1}{\frac{-8}{(1 - 0.9506173)^{2}} + \frac{170}{(2 - 0.9506173)^{2}}} \\
&= -\frac{1}{\frac{-8}{0.002438651} + \frac{170}{1.101204}} \\
&= -\frac{1}{-3280.502 + 154.3765} \\
&= 0.0003198848 \\
SD[\widehat{\psi^{mle}}] &= \sqrt{Var[\widehat{\psi^{mle}}]} \\
&= 0.01788532 \\
\end{align*}

Then, to find the confidence interval, we have: 

\begin{align*}
\widehat{\psi^{mle}} &\pm Z \cdot \widehat{SE} \\
\widehat{\psi^{mle}} &\pm Z \cdot \sqrt{-\frac{1}{\ell''(\widehat{\psi^{mle}})}} \\
0.9506173 &\pm 1.96 \cdot 0.01788532 \\
[0.9155621, & \: 0.9856725] \\
\end{align*}

Because the null hypothesis is $\psi = \frac{1 - 2\pi}{1 - \pi} = 0.3$ and $\pi = \frac{1 - \psi}{2 - \psi} = \frac{0.7}{1.7} = 0.4117647$.

And the $\widehat{\psi^{mle}} = 0.9506173$, we have $\pi = \frac{1 - \psi}{2 - \psi} = \frac{1 - 0.9506173}{2 - 0.9506173} = \frac{0.0493827}{1.049383} = 0.0470588$

```{r}
pbinom(q = 0.0470588* 170,size = 170, prob = 0.4117647, lower.tail = F)
```

## Bayesian

Let $X$ denote the number of infection cases among $n_1 = 17411$ subjects assigned to the BNT162b2 group

Let $Y$ denote the number of infection cases among $n_2 = 17511$ subjects assigned to the Placebo group.

Let $\pi_v$ and $\pi_p$ denote the probabilities of an infection in the vaccine and placebo groups respectively.

Therefore, we have $X \sim Binom(\pi_v, n_1 = 17411)$ and $Y \sim Binom(\pi_p, n_2 = 17511)$. 

Assuming the trial will run until $X+Y=s$ infections observed

Then, we can let T denote the number of cases in vaccine group from s=170 cases.

The distribution of T is well approximated by a bionomial for the vaccine study:

$$T \sim Binom(s,\pi)$$
where $\pi =$ P(vaccine|infection)

By Bayes'rule, we can write $\pi$ in terms of the probabilities $\pi_v$ and $\pi_p$ as follows:

$$\pi = \frac{n_1\pi_v}{n_1\pi_v+n_2\pi_p}$$
We know that $n_1=17411$ and $n_2=17511$

so $n_1 \approx n2$, we can say that the randomization is 1:1.

We can simplify $\pi$ as follows

\begin{align*}
\pi &= \frac{n_1\pi_v}{n_1\pi_v+n_2\pi_p} \\
&= \frac{n_1\pi_v}{n_1\pi_v+n_1\pi_p} \\
&= \frac{n_1\pi_v}{n_1(\pi_v+\pi_p)} \\
&= \frac{\pi_v}{\pi_v+\pi_p}
\end{align*}

Since $n_1$ and $n_2$ are large and the event rates are small, we can say

$$X \approx Pois(n_1\pi_v)$$
is independent of

$$Y \approx Pois(n_2\pi_p)$$

Then

\begin{align*}
P(T=t) &= P(X=t|X+Y=s) \ t=0,1,\dots, s \\
&= \frac{P(X=t \cap X+Y=s)}{P(X+Y=s)} \\
&= \frac{P(X=t \times Y=s-t)}{P(X+Y=s)} \text{ X and Y are indepedent} \\
&= \binom{s}{n} \pi^t (1-\pi)^{s-t} \text{where } \pi = \frac{\pi_v}{\pi_v+\pi_p}
\end{align*}

so we can have that

$$T \sim Binom(s=170, \pi=\frac{\pi_v}{\pi_v+\pi_p})$$

where $\pi_v$ and $\pi_p$ are the probabilities of an infection in the vaccine and placebo groups respectively.

The parameter of interest is vaccine efficacy $\psi$, that is 

\begin{align*}
\psi &= \frac{\pi_p - \pi_v}{\pi_p} \\
&= 1 - \frac{\pi_v}{\pi_p} \\
\end{align*}

Then, we can find $\frac{\pi_v}{\pi_p}$ by using $\pi$

\begin{align*}
\pi &= \frac{\pi_v}{\pi_v+\pi_p} \\
\pi(\pi_v+\pi_p) &= \pi_v \\
\pi \pi_v + \pi \pi_p &= \pi_v \\
\pi \pi_p &= \pi_v - \pi \pi_v \\
\pi \pi_p &= \pi_v (1 - \pi) \\
\frac{\pi_v}{\pi_p} &= \frac{\pi}{1-\pi}
\end{align*}

Then, we can find $\psi$

$\psi = 1 - \frac{\pi_v}{\pi_p} = 1 - \frac{\pi}{1-\pi} = \frac{1-2\pi}{1-\pi}$

Then, we can conduct a test of

Null Hypothesis: $H_0: \psi_0 = 0.3$

Alternative Hypothesis: $H_1: \psi_0 > 0.3$

```{r}
subject_v <- 17411
case_v <- 8
subject_p <- 17511
case_p <- 162

pi_v <- case_v/subject_v
pi_p <- case_p/subject_p
#pi <- pi_v/(pi_v+pi_p)
psi <- (pi_p - pi_v)/pi_p
psi
```
The estimated efficacy of BNT162b2 vaccine is 95.03337%.

BNT162b2 vaccine reduces risk of Covid-19 by about 95% compared to placebo.

The parameter $\pi$ was modeled with a $Beta(0.700102, 1)$ prior.

```{r, warning=F}
library(LearnBayes)

n <- 170
t <- 8

prior_alpha <- 0.700102
prior_beta <- 1

prior_median_pi <- qbeta(p=0.5, shape1=prior_alpha, shape2=prior_beta)
prior_median_pi
prior_0.05_pi <- qbeta(p=0.05, shape1=prior_alpha, shape2=prior_beta)
prior_0.05_pi

CI_pi_prior <- qbeta(p = c(0.025,0.975), shape1=prior_alpha, shape2=prior_beta)
CI_pi_lower <- CI_pi_prior[1]
CI_pi_upper <- CI_pi_prior[2]

prior_psi <- beta.select(quantile1 = list(p=0.5, x=0.4087779),
                             quantile2 = list(p=0.95, x=0.9859487))
prior_psi_alpha <- prior_psi[1]
prior_psi_alpha
prior_psi_beta <- prior_psi[2]
prior_psi_beta 

posterior_median_pi <- qbeta(p=0.5, shape1=t+prior_alpha, shape2=n-t+prior_beta)
posterior_median_pi
posterior_0.05_pi <- qbeta(p=0.05, shape1=t+prior_alpha, shape2=n-t+prior_beta)
posterior_0.05_pi

posterior_psi <- beta.select(quantile1 = list(p=0.5, x=0.94855003),
                         quantile2 = list(p=0.95, x=0.9727862))

posterior_psi_alpha <- posterior_psi[1]
posterior_psi_alpha
posterior_psi_beta <- posterior_psi[2]
posterior_psi_beta 
```

\begin{align*}
\psi &= \frac{1-2\pi}{1-\pi} \\
\psi (1-\pi) &= 1-2\pi \\
\psi - \psi \pi &= 1-2\pi \\
2\pi - \psi \pi &= 1 - \psi \\
\pi(2-\psi)  &= 1 - \psi \\
\pi &= \frac{1 - \psi}{2-\psi}
\end{align*}

Then, we can find the prior distribution of $\psi$

By using R, the prior median of $\pi$ is `r prior_median_pi`, and the prior 5 percentile of $\pi$ is `r prior_0.05_pi`.

Then, we can calculate the prior median of $\psi$ and prior 95 percentile of $\psi$

\begin{align*}
P(\pi > 0.3715522|t) &= 0.5 \\
P(\frac{1-\psi}{2-\psi} < 0.3715522|t) &= 0.5 \\
P(1-\psi < 0.3715522(2-\psi)|t) &= 0.5 \\
P(1-\psi < 0.7431044 - 0.3715522\psi|t) &= 0.5 \\
P(-0.6284478\psi < -0.2568956|t) &= 0.5 \\
P(\psi < 0.4087779|t) &= 0.5 \\
\end{align*}

\begin{align*}
P(\pi > 0.01385659|t) &= 0.95 \\
P(\frac{1-\psi}{2-\psi} < 0.01385659|t) &= 0.95 \\
P(1-\psi < 0.01385659(2-\psi)|t) &= 0.95 \\
P(1-\psi < 0.02771318 - 0.01385659\psi|t) &= 0.95 \\
P(-0.9861434\psi < -0.9722868|t) &= 0.95 \\
P(\psi < 0.9859487|t) &= 0.95 \\
\end{align*}

Thus, we have that the prior median of $\psi$ is 0.4087779, and the prior 95 percentile of $\psi$ is 0.9859487.

Therefore, we can say that the prior distribution of $\psi$ is: 

$g(\psi_0)$ = Beta(`r prior_psi_alpha`, `r prior_psi_beta`)

Then, we can find the posterior distribution of $\psi$

By using R, the posterior median of $\pi$ is `r posterior_median_pi`, and the posterior 5 percentile of $\pi$ is `r posterior_0.05_pi`.

\begin{align*}
P(\pi > 0.04893234|t) &= 0.5 \\
P(\frac{1-\psi}{2-\psi} < 0.04893234|t) &= 0.5 \\
P(1-\psi < 0.04893234(2-\psi)|t) &= 0.5 \\
P(1-\psi < 0.09786468 - 0.04893234\psi|t) &= 0.5 \\
P(-0.9510677\psi < -0.9021353|t) &= 0.5 \\
P(\psi < 0.94855003|t) &= 0.5 \\
\end{align*}

\begin{align*}
P(\pi > 0.02649278|t) &= 0.95 \\
P(\frac{1-\psi}{2-\psi} < 0.02649278|t) &= 0.95 \\
P(1-\psi < 0.02649278(2-\psi)|t) &= 0.95 \\
P(1-\psi < 0.05298556 - 0.02649278\psi|t) &= 0.95 \\
P(-0.9735072\psi < -0.9470144|t) &= 0.95 \\
P(\psi < 0.9727862|t) &= 0.95 \\
\end{align*}

Thus, we have that the posterior median of $\psi$ is 0.94855003, and the posterior 95 percentile of $\psi$ is 0.9727862.

Therefore, we can say that the posterior distribution of $\psi$ is:

$h(\psi_0|t)=$ Beta(`r posterior_psi_alpha`, `r posterior_psi_beta`)


```{r}
library(ggplot2)

ggplot()+
  stat_function(fun = dbeta,
                args = list(shape1 = prior_psi_alpha,
                            shape2 = prior_psi_beta))+
  stat_function(fun = dbeta,
                args = list(shape1 = posterior_psi_alpha,
                            shape2 = posterior_psi_beta),
                color='blue')+
  labs(title = "Prior(black) and Posterior(blue) for Vaccine Data",
       ylab = "Density",
       xlab = expression(psi))
```

The posterior distribution is skewed, so it is better to use HPDI for an interval estimate.

```{r}
CI_psi <- qbeta(p = c(0.025,0.975), shape1=posterior_psi_alpha, shape2=posterior_psi_beta)
CI_psi
CI_psi_lower <- CI_psi[1]
CI_psi_upper <- CI_psi[2]

library(HDInterval)
credible <- hdi(qbeta, credMass = 0.95, shape1=posterior_psi_alpha, shape2=posterior_psi_beta)
credible
credible_lower <- credible[1]
credible_upper <- credible[2]
```

The 95\% Bayesian confidence interval is [`r CI_psi_lower`, `r CI_psi_upper`], which indicate that there is a 95% probability that the true value of $\psi_0$ falls within the interval [`r CI_psi_lower`, `r CI_psi_upper`]. We are 95% confident that the true vaccine efficacy against Covid 19 is between approximately 90.59% and 97.63%.

The 95\% Bayesian credible interval is [`r credible_lower`, `r credible_upper`]. For $\psi$ represents the vaccine efficacy against Covid 19, the middle 95% of the posterior distribution of vaccine efficacy resulting from the prior is the range 91.05% to 97.92%. There is a 95% probability that $\psi_0$ in between 91.05% and 97.92%. .

Calculate posterior probability $P(\psi_0 > 0.3|t)$

```{r}
post_prob <- pbeta(q=0.3, shape1=posterior_psi_alpha, shape2=posterior_psi_beta, lower.tail = F)
post_prob
smaller_0.3 <- pbeta(q=0.3, shape1=posterior_psi_alpha, shape2=posterior_psi_beta)
smaller_0.3
```

The posterior probability $P(\psi_0 > 0.3|t)=1$, which indicates that approximately 100% of chance that the true vaccine efficacy against Covid 19 is greater than 30%. We can reject the null hypothesis that the vaccine efficacy is 30%. The evidence suggests that vaccine efficacy is greater than 30%.

### The burning question is whether the prior used by Pfizer was non-informativeor was it overly optimistic? 

We choose Beta(0.700102, 1) as the prior distribution of $\pi$. The prior distribution is chosen such that the mean is equal to 0.0471 ($\frac{8}{170}$) corresponding to expected vaccine efficacy 30%. The mean is much lower than vaccine efficacy = 30%, which means that it assigns a lower probability to values indicating higher vaccine efficacy, so the prior used by Pfizer was overly optimistic. Pfizer expressed a relatively high expectation for the vaccine's efficacy before observing the actual data.

## Bootstrap
```{r}
set.seed(666)

case_vaccine <- 8
total_vaccine <- 17411
case_placebo <- 162
total_placebo <- 17511
total_case <- case_vaccine + case_placebo

pi_v <- case_vaccine / total_vaccine
pi_p <- case_placebo / total_placebo
psi_hat <- (pi_p - pi_v) / pi_p
pi_hat <- pi_v / (pi_p + pi_v)

B <- 10000
```

### Parametric bootstrap

```{r, warning = F}
para_bootstrap_samples <- lapply(1:B, function(X) {
  bootstrap_t <- rbinom(1, size = total_case, prob = pi_hat)
  bootstrap_pi <- bootstrap_t / total_case
  bootstrap_psi_hat <- (1 - 2 * bootstrap_pi) / (1 - bootstrap_pi)
  data.frame(sample_pi = bootstrap_pi,
             sample_psi_hat = bootstrap_psi_hat)
})

para_sample_summary <- do.call(rbind, para_bootstrap_samples)

# Calculate the binwidth using the method we have learned in class:
# Here, n = B = 10000
# log2(10000) + 1 = 14.28771
# Here, I took a number of 15.
# Now, I need the range from my data.
# para_sample_summary$sample_psi_hat %>% range()
# From the summary, I got the range for the data is: 1.0000000 - 0.8741722= 0.1258278
# Thus, here, I resize the binwidth into 0.1258278/15 and breaks the bar by (0.8741722, 1.0000000, 0.1258278/15)
p1 <- ggplot(data = para_sample_summary,
       mapping = aes(x = sample_psi_hat)) + 
  geom_histogram(binwidth = 0.1258278/15,
                 breaks = seq(0.8741722, 1.0000000, 0.1258278/15),
                 alpha = 0.8,
                 color = 'gray') +
  labs(title =  expression(paste("The Distribution of the \nBootstrapped Sample ", widehat(psi))),
       subtitle = "n=10000",
       x = expression(widehat(psi)))

p2 <- ggplot(data = para_sample_summary, 
             mapping = aes(sample = sample_psi_hat)) +
  stat_qq(distribution = qnorm) + 
  stat_qq_line(distribution = qnorm) + 
  labs(title = "The Normal Probability Plot of \n the Bootstrapped Distribution")
p1+p2


# without bias correction
a = 0.05
z <- qnorm(p = 1 - a/2)
para_ci <- para_sample_summary %>% summarize(psi_hat = mean(sample_psi_hat),
                                         s = sd(sample_psi_hat),
                                         lower = psi_hat - z * s,
                                         upper = psi_hat + z * s)
para_ci$lower
para_ci$upper

# Perform hypothesis testing
h_0_psi <- 0.3
para_p_value <- sum(para_sample_summary$sample_psi_hat > h_0_psi) / B
para_p_value


# with bias correction
bias <- mean(para_sample_summary$sample_psi_hat) - psi_hat
ci_correction <- para_sample_summary %>% summarize(psi_hat = mean(sample_psi_hat),
                                         s = sd(sample_psi_hat),
                                         lower = psi_hat - bias - z * s,
                                         upper = psi_hat - bias + z * s)
ci_correction$lower
ci_correction$upper

corr_p_value <- sum(para_sample_summary$sample_psi_hat > h_0_psi) / B
corr_p_value

mosaic::prop.test(x = sum(para_sample_summary$sample_psi_hat > h_0_psi),
                  n = B, 
                  p = 0.3,
                  alt = "greater",
                  conf.level = 0.95,
                  correct = FALSE)

```

### Non-parametric bootstrap 

Simple percentile method 

```{r}
non_bootstrap_samples <- lapply(1:B, function(X) {
  # Resample from the combined dataset
  bootstrap_data <- sample(c(rep("vaccine", case_vaccine), 
                             rep("placebo", case_placebo)), 
                             total_case, replace = TRUE)
  bootstrap_case_vaccine <- sum(bootstrap_data == "vaccine")
  bootstrap_case_placebo <- sum(bootstrap_data == "placebo")
  bootstrap_pi_v <- bootstrap_case_vaccine / total_vaccine
  bootstrap_pi_p <- bootstrap_case_placebo / total_placebo

  bootstrap_psi_hat <- (bootstrap_pi_p - bootstrap_pi_v) / bootstrap_pi_p
  
  data.frame(sample_psi_hat = bootstrap_psi_hat)
})

non_sample_summary <- do.call(rbind, non_bootstrap_samples)

lower_ci <- quantile(non_sample_summary$sample_psi_hat, a/2)
upper_ci <- quantile(non_sample_summary$sample_psi_hat, 1 - a/2)

# Perform hypothesis testing
non_p_value <- sum(non_sample_summary$sample_psi_hat > h_0_psi) / B

lower_ci
upper_ci
non_p_value
```

## Results

  In this study, we have only 0.05\% of cases in the treatment group while we have 0.93\% of cases in the control group. In the Likelihood method, we first analyze the efficiency of BNT162b2 by comparing the parameters of control group and treatment group. We found $\psi = 0.9503337$, shows that we have 95\% efficiency of the treatment group, which pass the rule of at least 30\% efficacy for a new therapy to be approved. Moreover, we combined the results of both groups together to find the combined maximum likelihood estimator, which is 0.9506173. And then, use this estimator, we build a 95\% confidence interval: [0.9155621, 0.9856725].


## Discussion/Conclusion

## References

Coronavirus disease (COVID-19) pandemic. (2023, May 24).                  
https://www.who.int/europe/emergencies/situations/covid-19

Hwang TJ, Rabheru K, Peisah C, Reichman W, Ikeda M. Loneliness and social isolation during the COVID-19 pandemic. Int Psychogeriatr. 2020 Oct;32(10):1217-1220. doi: 10.1017/S1041610220000988. Epub 2020 May 26. PMID: 32450943; PMCID: PMC7306546.

“Adult Vaccination - Reasons to Vaccinate.” Centers for Disease Control and Prevention, 22 Sept. 2022, www.cdc.gov/vaccines/adults/reasons-to-vaccinate.html.

## Appendix
