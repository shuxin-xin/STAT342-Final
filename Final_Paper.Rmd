---
title: "BNT162b2 Vaccine Efficiency Analysis"
subtitle: "Likelihood, Bayesian, Bootstrapping"
author: "Yanting Hu, Liuyixin Shao, Shuxin Zhang"
graphics: yes
output: 
        pdf_document:
         toc: false
         number_sections: true
urlcolor: blue
header-includes:
- \usepackage{amsmath,amsfonts,amssymb}
- \usepackage{multicol,graphicx,hyperref,xcolor}
- \usepackage{setspace} \doublespacing
fontsize: 11pt

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r load-packages, message=FALSE, echo = F, warning = F}
library(tidyverse)
library(openintro)
library(maxLik)
library(ggplot2)
library(patchwork)
library(LearnBayes)
library(ggplot2)
library(HDInterval)
```

# Abstract

The coronavirus disease 2019 (Covid-19) has afflicted tens of millions of people around the world. A total of 34,922 participants were randomly selected, while 8 out of 17,411 in the BNT162b2 group were infected and 162 out of 17,511 in the Placebo group were infected. This paper is about security and Effectiveness tests for BNT162b2 Vaccine by using three methods: Likelihood, Bayesian, and Bootstrapping. We use the Likelihood method to find the estimator that can maximize the probability function most $\psi$ and construct a 95\% confidence interval. Besides, we also use Bayesian and Bootstrapping methods to build 95\% credible intervals and confidence intervals respectively. We found that BNT162b2 Vaccine conferred approximately 94% protection against Covid-19 in persons 16 years of age or beyond.

# Keywords

Covid-19; BNT162b2-vaccine; Likelihood; Bayesian; Bootstrapping

# Introduction

  In 2019, human beings experiences an unprecedented outbreak of respiratory infections. This is a worldwide disease known as coronavirus disease 2019 (Covid-19). The first cases of novel coronavirus are detected in China and then spread to other countries across the world. During more than 3 years pandemic, “over 2 million people in the European Region have died from the disease.” \footnote{(Coronavirus Disease (COVID-19) Pandemic)} At the beginning of the outbreak, people didn't expect it to last for a long time and treated it like a common flu. However, because the infected person is exposed to the crowd for a long time, the development of new coronary pneumonia is out of control and gradually forms a global disease.

  How to effectively control the epidemic? Isolation is often the first and most effective measure that comes to mind when attempting to control an epidemic. It is a logical approach since, without person-to-person contact, the virus cannot spread. However, it is essential to understand that this approach requires a sustained effort until the government can confidently ensure the quarantine of all infected individuals. It is undeniable that Quarantine and social distancing are one of the most effective ways to prevent the virus from spreading, however, this method also lead to "elevated levels of loneliness and social isolation, which in turn produce physical- and mental-health related repercussions." \footnote{(Hwang et al.)}
  
  So it becomes meaningful to control the spread of the virus from the human body itself, and vaccination is one of them. The effective vaccines can greatly reduce "diseases that once routinely harmed or killed babies, children, and adults." \footnote{(“Adult Vaccination - Reasons to Vaccinate.”)}
  
  BNT162b2 vaccine, a Covid 19 vaccine developed by Pfizer, has entered public's view. BNT162b2 is a vaccine containing modified RNA, encapsulated in lipid nanoparticles, that carries the genetic instructions for producing a stable form of the SARS-CoV-2 spike protein, which is anchored to the viral membrane. And in this research, individuals aged 16 years or older were randomly divided into two groups. One group received two doses of either a placebo or the BNT162b2 vaccine. The two doses were rigorously administered 21 days apart. And then, researchers measure the effectiveness of vaccine by record the number of occurrence of laboratory-confirmed COVID-19. By analyzing the data calculated, we could use many statistics model to illustrates the effectiveness of the BNT162b2 vaccine.
  
  Many previous studies have already explored the effects of the BNT162b2 vaccine, while this study illustrates and records a real-life experiment. In the following sections, we will analyse whether BNT162b2 vaccine is efficient and safety enough to against laboratory-confirmed Covid 19 by three methods: likelihood, Bayesian, and bootstrapping.


# Statistical Method
## Preprocessing
### Our Data
Based on the paper, we have the table:
\begin{table}[h]
\centering
\caption{Vaccine Efficacy against Covid 19 at least 7 days after second dose in patients without evidence of infection}
\begin{tabular}{cccc}
Group & Cases & No. of subjects\\ \hline
BNT162b2 & 8 & 17,411 \\
Placebo & 162 & 17,511 \\ \hline
Total & 170 & 34,922 \\ \hline
\end{tabular}
\end{table}
### Two Statistical Models and Their Corresponding Parameters and Assumptions
To do appropriate inference, our three models are built on two different approaches: 1) the two binomial proportions approach and 2) the one-sample binomial approach.

1) First, it's natural for us to treat the data into a two binomial proportions problem.

Let $X$ denote the number of infection cases among $n_1 = 17411$ subjects assigned to the BNT162b2 group and $Y$ denote the number of infection cases among $n_2 = 17511$ subjects assigned to the Placebo group.

Let $\pi_v$ and $\pi_p$ denote the probabilities of an infection in the vaccine and placebo groups respectively.

Since participants underwent randomization in the paper, every subject is independent of each other. With independence and infection probability $\pi_v$ and $\pi_p$ for the vaccine and placebo groups, a reasonable model that we can use for $X$ and $Y$ is $X \sim Binom(\pi_v, n_1 = 17411)$ and $Y \sim Binom(\pi_p, n_2 = 17511)$. 

Then, the parameter of interest, which is the vaccine efficacy is:
$\psi = 1 - \frac{\pi_v}{\pi_p} = \frac{\pi_p - \pi_v}{\pi_p}$

Based on the data from the table above, we can easily calculated that $\pi_v = \frac{8}{17411}$, $\pi_p = \frac{162}{17511}$, and $\hat{\psi} = \frac{\pi_p - \pi_v}{\pi_p}=0.9503337$.

That means the vaccine BNT162b2 can reduce risk of having COVID 19 by around 95\% compare to placebo.

We will utilize these approach in the non-parametric bootstrapping approach.

2) Second, we can further reduce the problem to a one sample problem by conditioning on the number of total cases and making more assumptions:

Let $S$ denote the total cases in two groups where $S=X+Y$ and let $T$ denotes the number of cases in vaccine group from $S$ total cases. 

Let $V$ denote the event that "being assigned to BNT162b2 group" and $I$ denote the event that "infections".

Then, $P(V)$, the probability of subjects being assigned to the BNT162b2 group, is $\frac{n_1}{n_1+n_2}$. Then, by the rule of complement, $P(V^c)$, the probability of subjects being assigned to the placebo group, is $\frac{n_2}{n_1+n_2}$.

Then, by distributive laws, $P(I)$, the probability of infections, is:
\begin{align*}
P(I) &= P(I\cap (V\cup V^c))=P((I\cap V)\cup(I\cap V^c))\\
&=P(I \cap V) + P(I \cap V^c) -P((I \cap V)\cap(I \cap V^c))\qquad\mbox{by addition rule}\\
&= P(I \cap V) + P(I^c \cap V^c)\qquad\mbox{since complement sets are disjointed}\\
&=P(I|V) P(V) + P(I|V^c) P(V^c) \qquad\mbox{by definition of conditional probability} \\
&= \pi_v \cdot \frac{n_1}{n_1+n_2} + \pi_p \cdot \frac{n_2}{n_1+n_2} \\
&= \frac{n_1 \pi_v + n_2 \pi_p}{n_1 + n_2}
\end{align*}
Let $\pi$ denote the probability of a subject with the BNT162b2 vaccine but in the infection group, that is $\pi = P(V|I)=P(\text{BNT162b2 | COVID 19})$.

Since participants underwent randomization in the paper, every case is independent of each other. With independence and a fixed probability of $\pi$, a reasonable model that we can use for $T$ is $T \sim Binom(s, \pi)$ where $\pi = P(V|I)$. Now, let's find $\pi$:

By Bayes’ rule, we know that $P(V|I) = \frac{P(I|V)P(V)}{P(I)}$

where $P(I|V)$ represents the probability of infections given that being assigned to BNT162b2 group, which is $\pi_v$ and $P(I|V^c)$ represents the probability of infections given that being assigned to placebo group, which is $\pi_p$.

Then, by definition of conditional probability, we can calculate $\pi = P(V|I)$ as follows:
$\pi = P(V|I) = \frac{P(I|V)P(V)}{P(I)} = \frac{\pi_v \cdot \frac{n_1}{n_1+n_2}}{\frac{n_1 \pi_v + n_2 \pi_p}{n_1 + n_2}} = \frac{n_1\pi_v}{n_1+n_2} \cdot \frac{n_1+n_2}{n_1 \pi_v + n_2 \pi_p} = \frac{n_1\pi_v}{n_1 \pi_v + n_2 \pi_p}$

By the table, we know that $n_1=17411$ and $n_2=17511$. Since $n_1 \approx n2$, we can say that the randomization is 1:1 and further approximate $\pi$ as $\pi = \frac{n_1\pi_v}{n_1\pi_v+n_2\pi_p}= \frac{n_1\pi_v}{n_1\pi_v+n_1\pi_p}= \frac{n_1\pi_v}{n_1(\pi_v+\pi_p)}= \frac{\pi_v}{\pi_v+\pi_p}$.

Then, the parameter of interest, which is the vaccine efficacy represented by $\pi$ is:
$\psi = 1 - \frac{\pi_v}{\pi_p} = 1 - \frac{\pi}{1-\pi} = \frac{1-2\pi}{1-\pi}$.

At the same time, we also know that $\pi = \frac{1 - \psi}{2 - \psi}$.

Based on the data from the table, we can easily calculated that $s=x+y=8+162=170$ and $\pi=\frac{\pi_v}{\pi_v+\pi_p}=0.04731632$. Then, $T \sim Binom(s=170, \pi=0.04731632)$ where $\pi_v$ and $\pi_p$ are the probabilities of an infection in the vaccine and placebo groups respectively.

We will utilize these approach in the Maximum Likelihood and Bayesian approach.

### Hypothesis of Interest

(To do hypothesis test for inference, we first need to make certain assumptions to make our test valid.) 

The FDA requires at least 30% efficacy for a new therapy to be approved. Let $\psi_0$ represent the true value of $\psi$, which is the vaccine efficacy for BNT162b2.

Then, our null hypothesis is: "The vaccine efficacy of BNT162b2 is 30%", which is $H_0: \psi_0=0.3$.

Our alternative hypothesis is: "The vaccine efficacy of BNT162b2 over 30%", which is $H_1: \psi_0>0.3$.


## Maximum Likelihood 

We used the one sample approach to solve the question. Let's find the Maximum Likelihood Estimator first.

Based on 4.1.2, we have know that $T$, the number of cases in vaccine group from total cases has the distribution $T \sim Binom(170, \pi_0)$ where $\pi_0 = \frac{1 - \psi_0}{2 - \psi_0}$.

We know that for Binomial distribution, the PDF is $f(t)=\binom{170}{t} \cdot \pi_0^{t} \cdot (1 - \pi_0)^{170 - t}$ for $0<\pi_0<1$. Then, replace $\pi_0$ as $\pi_0 = \frac{1 - \psi_0}{2 - \psi_0}$, we got the PDF of $T$ represented by $\psi_0$, which is $f(t)=\binom{170}{t} \cdot (\frac{1 - \psi}{2 - \psi})^{t} \cdot (1 - \frac{1 - \psi}{2 - \psi})^{170 - t}$ for $0<\frac{1 - \psi_0}{2 - \psi_0}<1$, which is $0<\psi<1$.

Then, indexed by a parameter $\psi$ with true value $\psi_0$ the likelihood function is:
\begin{align*}
L(\psi) &= \binom{170}{t} \cdot \left(\frac{1 - \psi}{2 - \psi}\right)^{t} \cdot \left(1 - \frac{1 - \psi}{2 - \psi}\right)^{170 - t} \\
&= \binom{170}{t} \cdot \left(\frac{1 - \psi}{2 - \psi}\right)^{t} \cdot \left(\frac{1}{2 - \psi}\right)^{170 - t}\qquad\mbox{for $0<\psi<1$}
\end{align*}
Since the $\psi$ that maximizes $L(\psi)$ also maximizes $\ell(\psi) = lnL(\psi)$, and $\ell(\psi)$ is much easier to work with, let’s
calculate the $\ell(\psi)$.
\begin{align*}
\ell(\psi) &= ln\left(\binom{170}{t} \cdot (\frac{1 - \psi}{2 - \psi})^{t} \cdot (\frac{1}{2 - \psi})^{170 - t}\right) \\
&= ln\left(\binom{170}{t}\right) + t \cdot (ln(1 - \psi) - ln(2 - \psi)) + (t - 170) \cdot ln(2 - \psi)\qquad\mbox{for $0<\psi_0<1$}
\end{align*}
Here, to maximize $\psi$, we need to take the derivative of $\ell(\psi)$ with respect to $\psi$ and set it to 0 to find the critical point. We also need to take the second derivative of $\ell(\psi)$ with respect to $\psi$ to prove that the critical point we get from the first derivative is the global maximum. If we only have one critical point and the second
derivative of $\ell(\psi)$ with respect to $\psi$ on that critical point is negative, that means the function $\ell(\psi)$ is always concave down and the critical point has the value of the global maximum for the function $\ell(\psi)$.

Let's start with the first derivative:
\begin{align*}
\frac{d}{d \psi} \ell(\psi) &= \frac{d}{d \psi} \left(ln\left(\binom{170}{t}\right) + t \cdot (ln(1 - \psi) - ln(2 - \psi)) + (t - 170) \cdot ln(2 - \psi)\right)=0 \\
&= -\frac{t}{1 - \psi} + \frac{t}{2 - \psi} - \frac{t - 170}{2 - \psi}=0 \\
&= -\frac{t}{1 - \psi} + \frac{170}{2 - \psi} = 0 \\
170 - 170 \cdot \psi &= 2t - t \cdot \psi \\
(170 - t) \cdot \psi &= 170 - 2t \\
\psi &= \frac{170 - 2t}{170 - t}
\end{align*}
Thus, $\frac{170 - 2t}{170 - t}$ is a candidate for MLE for $\psi_0$. To check whether this candidate is a maximum value, we need to calculate the second derivative test:
\begin{align*}
\frac{d^2}{d \psi^2} \ell(\psi) = \ell''(\psi) &= \frac{d}{d \psi} \left(-\frac{t}{1 - \psi} + \frac{170}{2 - \psi}\right) \\
&= \frac{-t}{(1 - \psi)^{2}} + \frac{170}{(2 - \psi)^{2}} \\
&= \frac{-t\cdot (2 - \psi)^{2} + 170 \cdot (1 - \psi)^{2}}{(1 - \psi)^{2} \cdot (2 - \psi)^{2}}
\end{align*}
From Table 1, given that 8 cases in Vaccine group, we know that $t=8$, then $\psi = \frac{170 - 2\cdot 8}{170 - \cdot 8}=0.9506173$. Then, $\ell''(\psi)=\frac{-8\cdot (2 - 0.9506173)^{2} + 170 \cdot (1 - 0.9506173)^{2}}{(1 - 0.9506173)^{2} \cdot (2 - 0.9506173)^{2}}=-3126.12565702$.

Since we only have one critical point and the second derivative of $\ell(\psi)$ with respect to $\psi$ on that critical point is negative, we can say that the function $\ell(\psi)$ is always concave down and the critical point, $\psi = \frac{170 - 2t}{170 - t}=0.9506173$ is the global maximum of $\ell(\psi)$.

Therefore, $\widehat{\psi_0^{mle}} = 0.9506173$ is a MLE for $\psi$. 

Since $n=170$, we know that under certain regularization, $\widehat{\psi_0^{mle}}$ is approximately normally distributed with mean $\psi_0$ and estimated standard error $-\frac{1}{\sqrt{\ell''(\widehat{\psi_0^{mle}})}}$

Plug in the value $\ell''(\widehat{\psi_0^{mle}})=-3126.12565702$, we have:
$$SD[\widehat{\psi_0^{mle}}] = -\frac{1}{\sqrt{\ell''(\widehat{\psi_0^{mle}})}}=-\frac{1}{\sqrt{-3126.12565702}}=0.01788532$$

Then, we can calculate the Wald confidence interval, which is: 
$$\widehat{\psi_0^{mle}} \pm Z_{\alpha/2} \cdot \widehat{SE}=\widehat{\psi_0^{mle}} \pm Z_{\alpha/2}=0.9506173 \pm 1.96 \times 0.01788532$$
Thus, the 95% confidence interval for the true value of $\psi_0$ is $[0.9155621, \: 0.9856725]$.

Then, we did a likelihood ratio test on $\psi$. Plug in $\psi_0^{mle}=0.9506173$ and $t=8$, we know that the likelihood ratio test statistic $W$ equals to:
\begin{align*}
W &= 2[\ell(\widehat{\psi^{mle}}) - \ell(\psi^{null})] \\
&= 2[ln\left(\binom{170}{t}\right) + t \cdot (ln(1 - \widehat{\psi^{mle}}) - ln(2 - \widehat{\psi^{mle}})) + (t - 170) \cdot ln(2 - \widehat{\psi^{mle}}) - \\
& \quad (ln\left(\binom{170}{t}\right) + t \cdot (ln(1 - \psi^{null}) - ln(2 - \psi^{null})) + (t - 170) \cdot ln(2 - \psi^{null}))] \\
&= 2[8(ln(1 - 0.9506173) - ln(2 - 0.9506173)) + (8 - 170)ln(2 - 0.9506173)\\
& \quad-(8 (ln(1 - 0.3) - ln(2 - 0.3)) + (8 - 170) ln(2 - 0.3))] \\
&= 121.6012 
\end{align*}

By chapter 25.2, we know that under $H_0$ with large sample: $W\approx \chi^2_1$.

Since large values of W provide evidence in the direction of the alternative, the P-value is the right tail probability from the $\chi^2_1$ distribution. 
```{r label="likelihood", include = FALSE, cache = TRUE}
pchisq(q = 121.6012, df = 1, lower.tail = F)
```
Thus, using R, the P-value for the Likelihood Ratio Test statistic using the approximate chi square distribution is $P(W < 121.6012) = 2.822313e\times 10^{-28}$, which is very small. So, we have enough evidence to reject the null hypothesis and we have $P(\psi > 0.3) = 1$. Therefore, we can conclude that the vaccine efficacy is greater than 30\%.

## Bayesian

### Prior Elicitation

Under the null hypothesis, the prior value of vaccine efficacy($\psi$) is 30%, meaning that $\pi = \frac{1-\psi}{2-\psi} = \frac{1-0.3}{2-0.3} = 0.4118$.

From 4.1.2 we know that $T\sim Binom(170, \pi)$ and we don't have explicit information about the prior. Thus, let's assume that $\pi$ follows beta distribution. Then, the expected value of $\pi$ is $E[\pi]=\frac{\alpha}{\alpha+\beta}$.

In the absence of explicit prior information or evidence, we also know that centering the prior at 0 is often a conservative choice since it avoids strong assumption and allows for a more unbiased approach. Since we have assumed that $\pi$ follows beta distribution, by the property of Beta Distribution, assuming the prior is centered closer to 0 indicating a prior belief that $\alpha$ and $\beta$ is more likely to have lower values, so we choose $\beta = 1$ and a smaller $alpha$ in this case. Let $\beta = 1$, then, 
\begin{align*}
\frac{\alpha}{\alpha+1} &= 0.4118 \\
\alpha &= 0.4118\alpha + 0.4118\\
0.5882\alpha &= 0.4118 \\
\alpha &= 0.700102
\end{align*}
Therefore, the a proper prior of $\pi$ is: $g(\pi_0) = Beta(0.700102, 1)$. However, this prior may be informative to the posterior because we assume the prior of $\pi$ is a Beta distribution. Therefore, we also choose a completely non informative uniform prior distribution of $\pi$, that is $g(\pi_0) = Beta(1,1)$ because The $Beta(1, 1)$ distribution is symmetric around its center (0.5, 0.5) and assigns equal probability to all values between 0 and 1.

### Calculating the Posterior Distribution

- Beta(0.700102, 1) prior:

Since $T \sim Binom(s=170, \pi=\frac{\pi_v}{\pi_v+\pi_p})$ and we assume $\pi$ follows a Beta Distribution $g(\pi_0) = Beta(0.700102, 1)$. Then, the posterior of $\pi$ is also a Beta Distribution with shape parameters $0.700102+t$ and $170-t+1$, where $t=8$ from Table 1. Therefore, we have: $h(\pi_0|t) = Beta(0.700102+8, 170-8+1) = Beta(8.700102, 163)$

```{r label="interval_prior_1", include = FALSE, cache = TRUE}
interval <- qbeta(p = c(0.025,0.975), shape1=8.700102, shape2=163)
```

Calculated by R, the 2.5 percentile of posterior distribution of $\pi$ is 0.02319402, and the 97.5% percentile of posterior distribution of $\pi$ is 0.08799074. Since by 4.1.2, we know that $\psi = \frac{1-2\pi}{1-\pi}$, we can calculate the 95\% Bayesian credible interval, that is:
$$[\frac{1-2 \times 0.08799074}{1-0.08799074},\frac{1-2 \times 0.02319402}{1-0.02319402}] = [0.9035199, 0.9762552]$$

- Beta(1, 1) prior:

Since $T \sim Binom(s=170, \pi=\frac{\pi_v}{\pi_v+\pi_p})$ and we assume $\pi$ follows a Beta Distribution $g(\pi_0) = Beta(1, 1)$. Then, the posterior of $\pi$ is also a Beta Distribution with shape parameters $1+t$ and $170-t+1$, where $t=8$ from Table 1. Therefore, we have: $h(\pi_0|t) = Beta(1+8, 170-8+1) = Beta(9, 163)$

```{r label="interval_prior_2", include = FALSE, cache = TRUE}
interval_uniform <- qbeta(p = c(0.025,0.975), shape1=9, shape2=163)
```

Calculated by R, the 2.5 percentile of posterior distribution of $\pi$ is 0.02434818, and the 97.5% percentile of posterior distribution of $\pi$ is 0.092214. Since by 4.1.2, we know that $\psi = \frac{1-2\pi}{1-\pi}$, we can calculate the 95\% Bayesian credible interval, that is:
$$[\frac{1-2 \times 0.09009896}{1-0.09009896},\frac{1-2 \times 0.02434585}{1-0.02434585}] = [0.9009794,0.9750466]$$

We also plot the prior and posterior distribution plot for both of the approaches.

```{r label="graph", echo=F, eval=F, fig.height=3.5, fig.width=9}
p_a <- ggplot()+
  geom_function(fun = dbeta,
                args = list(shape1 = 0.700102,
                            shape2 = 1),
                mapping = aes(color = "prior")) +
  geom_function(fun = dbeta,
                args = list(shape1 = 0.700102+8,
                            shape2 = 170-8+1),
                mapping = aes(color = "posterior")) +
  labs(title = "Beta(0.700102, 1) Prior and Beta(8.700102, 163) \nPosterior for Vaccine Data",
       y = "PDF",
       x = expression(pi),
       color = "Distribution")

p_b <- ggplot()+
  geom_function(fun = dbeta,
                args = list(shape1 = 1,
                            shape2 = 1),
                mapping = aes(color = "prior")) +
  geom_function(fun = dbeta,
                args = list(shape1 = 1+8,
                            shape2 = 170-8+1),
                mapping = aes(color = "posterior")) +
  labs(title = "Beta(1, 1) Prior and Beta(9, 163)\nPosterior for Vaccine Data",
       y = "PDF",
       x = expression(pi),
       color = "Distribution")

p_a+p_b
```


### Calculate the Bayesian P-value

Since $\psi = \frac{1-2\pi}{1-\pi}$, we can calculate posterior probability, that is:
$$P(\psi_0 \leq 0.3|t) = P(\frac{1-2\pi}{1-\pi} \leq 0.3|t) = P(\pi \geq 0.4117647|t)$$

```{r label="probability", echo=F, eval=F}
post_prob_pi <- pbeta(q=0.4117647, shape1=8.700102, shape2=163, lower.tail = F)
```

Using R, we calculated that the posterior probability $P(\psi_0 \leq 0.3|t)=1.96 \times 10^{-28}$, which is very small. Thus, $P(\psi_0 > 0.3|t)$ is approximately 1, which means that the probability that the true vaccine efficacy against COVID 19 is greater than 30% is about 100%. The evidence suggests that vaccine efficacy is greater than 30%.

### Examine sensitivity to the choice of prior distribution

For prior Beta(0.700102, 1), the 95\% Bayesian credible interval width is approximately 0.0727. For prior Beta(1, 1), the 95\% Bayesian credible interval width is approximately 0.0741. We can see that the 95\% Bayesian credible interval for the Beta(1, 1) non-informative prior is slightly wider than that of Beta(0.700102, 1) prior. We can say that the non-informative prior has a larger range of possible values for $\psi_0$, which is vaccine efficacy, so the Beta(1, 1) non-informative prior has greater uncertainty, which has wider interval. Therefore, the choice of prior distribution will influence the width of the credible interval.

## Non-parametric Bootstrap 
```{r label="bootstrap", include = FALSE, cache = TRUE, warning=F}
set.seed(666)
case_vaccine <- 8
total_vaccine <- 17411
case_placebo <- 162
total_placebo <- 17511
total_case <- case_vaccine + case_placebo
pi_v <- case_vaccine / total_vaccine
pi_p <- case_placebo / total_placebo
psi_hat <- (pi_p - pi_v) / pi_p
pi_hat <- pi_v / (pi_p + pi_v)
B <- 10000
a = 0.05
z <- qnorm(p = 1 - a/2)
h_0_psi <- 0.3
```

To use the non parametric bootstrapping to construct a 95% bootstrap confidence interval for the BNT162b2 vaccine efficacy $\psi$, we do not need to make any assumption about the probability distribution of the sample. We can directly generate 10000 $\pi_v$ and $\pi_p$ to calculate the exact $\psi$ for each generated sample and do the inference. Here, we assume that the population distribution for the infection in the vaccine group is a discrete probability distribution that gives probability $\frac{1}{170}$ (since we have a total number of 170 infections) to each observed participants who is vaccinated the BNT162b2 vaccine but is infected by COVID 19. We assume that the population distribution for the infection in the placebo group is a discrete probability distribution that gives probability $\frac{1}{170}$ to each observed participants who is not vaccinate the BNT162b2 vaccine and is infected by COVID 19.

After generating 10000 bootstrapped estimates of $\psi_0$, we can see that from the histogram the bootstrapped sampling distribution is skewed to the right and the sample data points on the quantile quantile plot do not fit the line very well. Therefore, a normal distribution is not a good fit for our bootstrapped samples of $\psi_0$. Thus, we cannot construct the standard bootstrap 95% interval. Instead, here, we construct the 95% bootstrap percentile interval with the simple percentile method because it doesn't need any assumption about the distribution of $\psi_0$.

```{r label="interval", include = FALSE, cache = TRUE, warning = F}
non_bootstrap_samples <- lapply(1:B, function(X) {
  # Resample from the combined dataset
  bootstrap_data <- sample(c(rep("vaccine", case_vaccine), 
                             rep("placebo", case_placebo)), 
                             total_case, replace = TRUE)
  bootstrap_case_vaccine <- sum(bootstrap_data == "vaccine")
  bootstrap_case_placebo <- sum(bootstrap_data == "placebo")
  bootstrap_pi_v <- bootstrap_case_vaccine / total_vaccine
  bootstrap_pi_p <- bootstrap_case_placebo / total_placebo
  bootstrap_psi_hat <- (bootstrap_pi_p - bootstrap_pi_v) / bootstrap_pi_p
  data.frame(sample_psi_hat = bootstrap_psi_hat)
})
non_sample_summary <- do.call(rbind, non_bootstrap_samples)

# Calculate the binwidth using the method we have learned in class:
# Here, n = B = 10000
# log2(10000) + 1 = 14.28771
# Here, I took a number of 15.
# Now, I need the range from my data.
# para_sample_summary$sample_psi_hat %>% range()
# From the summary, I got the range for the data is: 1.0000000 - 0.8659009 = 0.1340991
# Thus, here, I resize the binwidth into 0.1340991/15 and breaks the bar by (0.8659009, 1.0000000, 0.1340991/15)

p1 <- ggplot(data = non_sample_summary,
       mapping = aes(x = sample_psi_hat)) + 
  geom_histogram(binwidth = 0.1258278/15,
                 breaks = seq(0.8741722, 1.0000000, 0.1258278/15), 
                 alpha = 0.8,
                 color = 'gray') +
  labs(title =  expression(paste("The Bootstrapped \nSampling Distribution of ", widehat(psi))),
       subtitle = "n=10000",
       x = expression(widehat(psi)))

p2 <- ggplot(data = non_sample_summary, 
             mapping = aes(sample = sample_psi_hat)) +
  stat_qq(distribution = qnorm) + 
  stat_qq_line(distribution = qnorm) + 
  labs(title = "The Normal Probability Plot of \nthe Bootstrapped Distribution",
       subtitle = "n=10000",
       x = "theoretical",
       y = "sample")
p1+p2

lower_ci <- quantile(non_sample_summary$sample_psi_hat, a/2)
upper_ci <- quantile(non_sample_summary$sample_psi_hat, 1 - a/2)

# Perform hypothesis testing
non_p_value <- sum(non_sample_summary$sample_psi_hat < h_0_psi) / B
```

```{r echo = FALSE, warning=F}
p1+p2
```

Calculated by the R, the 95% simple bootstrap confidence interval for the true value of the vaccine efficacy $\psi_0$ is (`r lower_ci`, `r upper_ci`). That is, we are 95% confident that the true value of the vaccine efficacy $\psi_0$ is between `r lower_ci` and `r upper_ci`. 

The p-value is defined by presuming $\psi=0.3$ is true, of observing our test statistic or a value that is larger than $\psi=0.3$. Since all $\psi$ in our generate sample are greater or equal to 0.8659009, all of the generated samples' test statistic are greater than 0.3, which in the null hypothesis. Therefore, the p-value is 1. That is we are 100% confident that our test statistics contradicts the null hypothesis. 

# Results

\begin{table}[h]
\centering
\caption{Comparsion Table (ConfI: 95\% Confidence Interval, CredI: 95\% Credible Interval)}
\begin{tabular}{|c|c|c|c|}\hline
Approach & Lower Bound & Upper Bound & p-value \\ \hline
Maximum Likelihood (ConfI) & 0.9155621 & 0.9856725 & 1  \\ \hline
Bayesian prior Beta(0.700102, 1) (CredI) &  0.9035199 & 0.9762552 & 1 \\ \hline
Bayesian Prior Beta(1, 1) (CredI) & 0.9009794 & 0.9750466 & 1 \\ \hline
Non-parametric Bootstrap (ConfI) & 0.9097410 & 0.9819328 & 1\\ \hline
\end{tabular}
\end{table}

  In this study, we have only 0.05\% of cases in the treatment group while we have 0.93\% of cases in the control group. In the Likelihood method, we first analyze the efficiency of BNT162b2 by comparing the parameters of control group and treatment group. We found $\psi = 0.9503337$, shows that we have 95\% efficiency of the treatment group, which pass the rule of at least 30\% efficacy for a new therapy to be approved. Moreover, we combined the results of both groups together to find the combined maximum likelihood estimator, which is 0.9506173. And then, use this estimator, we build a 95\% confidence interval: [0.9155621, 0.9856725]. We also calculate at $t = 8$, $W = 106.5508$, and by this, we have $P(W > 106.5508) = P(\psi > 0.3) = 1$
  
  Then, in the Bayesian analysis, based on the given information and the prior distribution: $Beta(0.700102, 1)$, we then can calculate the posterior distribution: $Beta(8.700102, 163)$. Also, the 95\% Bayesian credible interval is [0.9035199, 0.9762552]. Besides, we consider a non informative uniform prior distribution of $\pi$: $Beta(1,1)$. The posterior distribution for this non informative uniform prior distribution is $Beta(9,163)$ and the 95\% Bayesian credible interval is [0.9009794, 0.9750466]. These results are slightly different because in Bayesian analysis, the choice of prior distribution can impact the posterior distribution and, consequently, the calculation of the confidence interval.
  
  The third method is Non-parametric Bootstrapping. By generating 10000 bootstrapped estimation of $\psi_0$, we can construct a 95% confidence interval: [0.9097410, 0.9819328].
  
  Based on table provided above, we can see the p-value for all three analysis methods are all 1. For the likelihood method and also the Bootstrapping method, we calculate the p-value $P(W < 106.5508) = 1.478737 \times 10^{-24}$ and empirical p-value $P(N0.\hat{\psi} < 0.3) = 0$ respectively. Moreover, the p-value for Bayesian posterior probability is $P(\psi_0 \leq 0.3|t)= 1.96 \times 10^{-28}$. Therefore, we have enough evidence to reject the null hypothesis. That is the efficiency of the vaccine is larger than 30\%.
  

# Discussion/Conclusion

  Under regularity conditions, the likelihood estimates converge to the true parameter values as the sample size increases. This property ensures that the likelihood method produces consistent estimates. Bayesian... Bootstrapping...  In conclusion, the findings from the three analysis methods (Maximum Likelihood, Bayesian, and non-parametric bootstrapping) are consistent, indicating a high efficacy of the BNT162b2 vaccine.
  
## The burning question is whether the prior used by Pfizer was non-informative or was it overly optimistic? 

We choose a completely non informative uniform prior distribution Beta(1,1) of $\pi$, assuming equal probabilities for all values of $\pi$ between 0 and 1. It is non-informative because it does not favor any specific value of $\pi$. In this case, the prior Beta(1,1) is not based on prior belief or expected vaccine efficacy. We also choose Beta(0.700102, 1) as the prior distribution of $\pi$. The prior distribution is chosen such that the mean is equal to 0.4118 ($\frac{1-0.3}{2-0.3}$) corresponding to expected vaccine efficacy 30%. The mean is higher than vaccine efficacy = 30%, which means that Pfizer assigns a higher probability to indicate lower vaccine efficacy, so the prior used by Pfizer was pessimistic. Pfizer expressed a relatively low expectation for the vaccine's efficacy before observing the actual data. The chosen prior Beta(0.700102, 1) is informative to some extent because it assumes an expected vaccine efficacy of 30%. This implies that there is some prior belief or evidence to suggest a certain level of efficacy. 

# References
“Adult Vaccination - Reasons to Vaccinate.” Centers for Disease Control and Prevention, 22 Sept. 2022, www.cdc.gov/vaccines/adults/reasons-to-vaccinate.html.

Coronavirus disease (COVID-19) pandemic. (2023, May 24).                  
https://www.who.int/europe/emergencies/situations/covid-19

Hwang TJ, Rabheru K, Peisah C, Reichman W, Ikeda M. Loneliness and social isolation during the COVID-19 pandemic. Int Psychogeriatr. 2020 Oct;32(10):1217-1220. doi: 10.1017/S1041610220000988. Epub 2020 May 26. PMID: 32450943; PMCID: PMC7306546.

Polack, Fernando P., et al. “Safety and Efficacy of the BNT162b2 mRNA Covid-19 Vaccine.” The New England Journal of Medicine, 10 Dec. 2020, doi.org/10.1056/nejmoa2034577.

# Appendix

The parameter of interest is vaccine efficacy $\psi$, that is 
\begin{align*}
\psi &= \frac{\pi_p - \pi_v}{\pi_p} \\
&= 1 - \frac{\pi_v}{\pi_p} \\
\end{align*}
Then, we can find $\frac{\pi_v}{\pi_p}$ by using $\pi$
\begin{align*}
\pi &= \frac{\pi_v}{\pi_v+\pi_p} \\
\pi(\pi_v+\pi_p) &= \pi_v \\
\pi \pi_v + \pi \pi_p &= \pi_v \\
\pi \pi_p &= \pi_v - \pi \pi_v \\
\pi \pi_p &= \pi_v (1 - \pi) \\
\frac{\pi_v}{\pi_p} &= \frac{\pi}{1-\pi}
\end{align*}
- (we can put these steps in the appendix)

## Code for Likelihood
```{r ref.label="likelihood", echo = TRUE, eval = F}

```

## Code for Bayesian
```{r ref.label="interval_prior_1", echo = TRUE, eval = F}

```

```{r ref.label="interval_prior_2", echo = TRUE, eval = F}

```

```{r ref.label="graph", echo = TRUE, eval = F}

```

```{r ref.label="probability", echo = TRUE, eval = F}

```

```{r ref.label="method1", echo = TRUE, eval = F}

```

## Code for Bootstrap
```{r ref.label="bootstrap", echo = TRUE, eval = F}

```

```{r ref.label="interval", echo = TRUE, eval = F}

```
